<div class="container mt-5">
  <h2 class="mb-4 text-dark">Comparaison de fichiers Excel / CSV</h2>

  <div class="row mt-3 g-3">
    <!-- Fichier 1 -->
    <div class="col-md-4">
      <label for="file1" class="form-label fw-bold">Fichier de référence</label>
      <input type="file" id="file1" class="form-control" (change)="onFile1Change($event)">
    </div>

    <!-- Fichier 2 -->
    <div class="col-md-4">
      <label for="file2" class="form-label fw-bold">Fichier à comparer</label>
      <input type="file" id="file2" class="form-control" (change)="onFile2Change($event)">
    </div>

    <!-- Fichier 3 -->
    <div class="col-md-4">
      <label for="file3" class="form-label fw-bold">Fichier à comparer (optionnel)</label>
      <input type="file" id="file3" class="form-control" (change)="onFile3Change($event)">
    </div>
  </div>

  <!-- Bouton -->
  <div class="text-center mt-4">
    <button class="btn btn-primary btn-lg px-5" (click)="comparer()" [disabled]="isLoading">
      <i class="bi bi-arrow-repeat me-2" *ngIf="isLoading"></i>
      {{ isLoading ? 'Comparaison en cours...' : 'Comparer les fichiers' }}
    </button>
  </div>
</div>

<!-- Résultats -->
<div class="container mt-4">
  <h2 class="mb-4">Résultats de la comparaison:</h2>

  <!-- Onglets principales -->
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" *ngFor="let tab of tabs; let i = index" role="presentation">
      <button class="nav-link" [class.active]="i === 0" data-bs-toggle="tab" [attr.data-bs-target]="'#' + tab.id"
        [attr.aria-controls]="tab.id" type="button" role="tab">
        {{ tab.title }}
      </button>
    </li>
  </ul>

  <div *ngIf="results && tabs.length > 0; else noData" class="comparison-wrapper mb-4">

    <!-- Zone scrollable -->
    <div class="scrollable-content p-2">

      <div class="tab-content mt-3 mb-4">
        <div class="tab-pane fade shadow-sm rounded" *ngFor="let tab of tabs; let i = index" [class.show]="i === 0"
          [class.active]="i === 0" [ngClass]="{'has-subnav': tab.type === 'missing'}" [id]="tab.id" role="tabpanel">

          <!-- Cas same_name_diff_matricule -->
          <div *ngIf="tab.type === 'same'">
            <div *ngFor="let item of getPagedData(tab); let i = index" class="card mb-3 shadow-sm">
              <div class="card-header fw-bold fs-5 text-muted">
                {{ (currentPage - 1) * pageSize + i + 1 }}. {{ item.nom_prenom | titlecase }}
              </div>
              <div class="card-body d-flex justify-content-between">
                <div class="flex-fill text-center border-end">
                  <h6 class="fw-bold text-success">{{ file1Name }}</h6>
                  <div *ngIf="item.df1?.length; else emptyDf1">
                    <div *ngFor="let rec of item.df1">{{ rec.matricule }} <small class="text-muted">({{
                        rec.date_naissance || '-' }})</small></div>
                  </div>
                  <ng-template #emptyDf1><span class="text-muted">-</span></ng-template>
                </div>
                <div class="flex-fill text-center border-end">
                  <h6 class="fw-bold text-success">{{ file2Name }}</h6>
                  <div *ngIf="item.df2?.length; else emptyDf2">
                    <div *ngFor="let rec of item.df2">{{ rec.matricule }} <small class="text-muted">({{
                        rec.date_naissance || '-' }})</small></div>
                  </div>
                  <ng-template #emptyDf2><span class="text-muted">-</span></ng-template>
                </div>
                <div class="flex-fill text-center">
                  <h6 class="fw-bold text-success">{{ file3Name }}</h6>
                  <div *ngIf="item.df3?.length; else emptyDf3">
                    <div *ngFor="let rec of item.df3">{{ rec.matricule }} <small class="text-muted">({{
                        rec.date_naissance || '-' }})</small></div>
                  </div>
                  <ng-template #emptyDf3><span class="text-muted">-</span></ng-template>
                </div>
              </div>
              <div class="card-footer">
                <span class="badge bg-warning text-dark" *ngIf="hasConflict(item)">Conflit</span>
                <span class="badge bg-secondary ms-2" *ngIf="hasDuplicates(item)">Doublons</span>
              </div>
            </div>
          </div>

          <!-- Cas missing -->
          <div *ngIf="tab.type === 'missing'">
            <ul class="nav nav-pills mb-0" id="pills-tab" role="tablist">
              <li class="nav-item" role="presentation" *ngIf="tab.data.df1?.length">
                <button class="nav-link active" id="pills-df1-tab" data-bs-toggle="pill" data-bs-target="#pills-df1"
                  type="button" role="tab">{{ file1Name | uppercase }}</button>
              </li>
              <li class="nav-item" role="presentation" *ngIf="tab.data.df2?.length">
                <button class="nav-link" id="pills-df2-tab" data-bs-toggle="pill" data-bs-target="#pills-df2"
                  type="button" role="tab">{{ file2Name | uppercase }}</button>
              </li>
              <li class="nav-item" role="presentation" *ngIf="tab.data.df3?.length">
                <button class="nav-link" id="pills-df3-tab" data-bs-toggle="pill" data-bs-target="#pills-df3"
                  type="button" role="tab">{{ file3Name | uppercase }}</button>
              </li>
            </ul>

            <div class="tab-content">
              <ng-container *ngFor="let sub of ['df1','df2','df3']; let idx = index">
                <div class="tab-pane fade" [class.show]="idx === 0" [class.active]="idx === 0" [id]="'pills-' + sub"
                  role="tabpanel" *ngIf="tab.data[sub]?.length">

                  <table class="table table-bordered table-hover text-center align-middle">
                    <thead class="table-dark thead-fixed">
                      <tr>
                        <th>#</th>
                        <th>Nom & Prénom</th>
                        <th>Matricule</th>
                        <th>Date de naissance</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let item of getPagedData(tab, sub); let i = index">
                        <td>{{ (currentPage - 1) * pageSize + i + 1 }}</td>
                        <td>{{ item.nom_prenom | titlecase }}</td>
                        <td class="fw-bold">{{ item.matricule }}</td>
                        <td>
                          {{ item.date_naissance !== '-'
                          ? (item.date_naissance.length === 10
                          ? item.date_naissance
                          : (item.date_naissance | slice:0:10))
                          : '-' }}
                        </td>

                        <!-- <td>{{ item.date_naissance }}</td> -->
                      </tr>
                    </tbody>
                  </table>
                </div>
              </ng-container>
            </div>
          </div>

          <!-- Cas diffs -->
          <div *ngIf="tab.type === 'diffs'">
            <div class="alert alert-info small mb-3">
              Liste des différences détectées colonne par colonne.
            </div>
            <div class="accordion mt-4" id="accordionDiffs">
              <div class="accordion-item" *ngFor="let group of pagedDiffs; let i = index">
                <h2 class="accordion-header" id="heading{{ i }}">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    [attr.data-bs-target]="'#collapse' + (i + (currentPage - 1) * pageSize)" aria-expanded="false">
                    Matricule : <span class="fw-bold ms-1">{{ group.key }}</span>
                    <span class="badge bg-warning ms-3">{{ group.differences.length }} différences</span>
                  </button>
                </h2>
                <div [id]="'collapse' + (i + (currentPage - 1) * pageSize)" class="accordion-collapse collapse"
                  [attr.aria-labelledby]="'heading' + (i + (currentPage - 1) * pageSize)"
                  data-bs-parent="#accordionDiffs">
                  <div class="accordion-body">
                    <table class="table table-sm table-striped align-middle">
                      <thead class="table-dark">
                        <tr>
                          <th>Colonne</th>
                          <th>Valeur dans {{ file1Name }}</th>
                          <th>Valeur dans {{ file2Name }}</th>
                          <th *ngIf="file3Name">Valeur dans {{ file3Name }}</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let diff of group.differences">
                          <td>{{ diff.column }}</td>
                          <td>{{ diff.df1_value }}</td>
                          <td>{{ diff.df2_value }}</td>
                          <td *ngIf="file3Name">{{ diff.df3_value }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pagination fixée en bas -->
    <div class="pagination-container mb-3 mt-3 border-top pt-2">
      <nav *ngIf="getTotalPages() > 1" aria-label="Pagination">
        <ul class="pagination justify-content-center mb-0">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <button class="page-link" (click)="changePage(currentPage - 1)">Précédent</button>
          </li>
          <li class="page-item" *ngFor="let p of getVisiblePages()" [class.active]="p === currentPage"
            [class.disabled]="p === '...'">
            <button class="page-link" *ngIf="p !== '...'" (click)="changePage(+p)">{{ p }}</button>
            <span class="page-link" *ngIf="p === '...'">...</span>
          </li>
          <li class="page-item" [class.disabled]="currentPage === getTotalPages()">
            <button class="page-link" (click)="changePage(currentPage + 1)">Suivant</button>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <ng-template #noData>
    <div class="alert alert-info text-center p-4">
      Aucun résultat à afficher.<br>
      <small class="text-muted">Importez vos fichiers et lancez une comparaison.</small>
    </div>
  </ng-template>
</div>